<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网易云音乐工具箱</title>
    <meta name="theme-color" content="#6c5ce7">
    <link href="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/aplayer/1.10.1/APlayer.min.css">
    <link rel="stylesheet" href="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css">
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='32' fill='%236c5ce7'/%3E%3Cpath fill='white' d='M44 14v26.5a6.5 6.5 0 1 1-3-5.5V24l-16 3.2V40.5a6.5 6.5 0 1 1-3-5.5V23.2L44 19V14z'/%3E%3C/svg%3E">
    <style>
        :root {
            --bg: #f5f7fb;
            --text: #1f2328;
            --muted: #6a737d;
            --card-bg: #ffffff;
            --border: #e6e8eb;
            --primary: #6c5ce7;
            --primary-700: #5a4ed0;
            --success: #2ecc71;
            --warning: #f1c40f;
            --info: #3498db;
        }
        /* 深色模式已移除，保留浅色主题 */
        body { background: var(--bg); color: var(--text); }
        .container { max-width: 1000px; }
        .navbar { background: var(--card-bg); border-bottom: 1px solid var(--border); }
        .navbar .btn-link { color: var(--text); }
        .app-hero {
            background: linear-gradient(135deg, rgba(108,92,231,.12), rgba(88,166,255,.10));
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 28px 24px;
            box-shadow: 0 2px 16px rgba(0,0,0,.05);
        }
        .app-hero h1 { font-weight: 800; letter-spacing: .2px; }
        .app-hero .subtitle { color: var(--muted); }
        .mode-tabs .nav-link {
            border-radius: 999px;
            border: 1px solid var(--border);
            color: var(--text);
            background: var(--card-bg);
            transition: transform .12s ease, background-color .12s ease;
        }
        .mode-tabs .nav-link:hover { transform: translateY(-1px); }
        .mode-tabs .nav-link.active { background: var(--primary); color: #fff; border-color: transparent; box-shadow: 0 6px 20px rgba(108,92,231,.25); }
        .card { background: var(--card-bg); border-color: var(--border); }
        .card.shadow-sm { box-shadow: 0 1px 10px rgba(0,0,0,.06) !important; }
        .form-label { font-weight: 600; }
        .form-control, .form-select { background: var(--card-bg); color: var(--text); border-color: var(--border); }
        .form-control::placeholder { color: var(--muted); }
        .btn-primary { background: var(--primary); border-color: var(--primary); }
        .btn-primary:hover { background: var(--primary-700); border-color: var(--primary-700); }
        .btn-success { background: var(--success); border-color: var(--success); }
        .btn-warning { background: var(--warning); border-color: var(--warning); color: #111; }
        .badge.bg-info { background-color: var(--info) !important; color: #102a43 !important; }
        #song-info img { max-width: 100%; border-radius: 12px; }
        .alert-info { background-color: rgba(88,166,255,.12); color: var(--info); border-color: rgba(88,166,255,.25); }
        .song-title, .playlist-title { display: inline-block; max-width: 260px; vertical-align: middle; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .list-group-item .select-song { flex-shrink: 0; margin-left: 10px; }
        .list-group-item { background: var(--card-bg); color: var(--text); border-color: var(--border); transition: background-color .15s ease, transform .06s ease; }
        .list-group-item:hover { background: rgba(108,92,231,.06); }
        .lyric-box {
            max-height: 220px;
            overflow-y: auto;
            background: linear-gradient(90deg, rgba(247,247,250,1) 60%, rgba(240,244,250,1) 100%);
            border-radius: 10px;
            padding: 12px 16px;
            font-size: 15px;
            color: var(--text);
            box-shadow: 0 1px 6px rgba(0,0,0,0.05);
            line-height: 1.7;
            margin-bottom: 0;
        }
        /* 深色模式样式已移除 */
        html, body { height: 100%; }
        body { min-height: 100vh; display: flex; flex-direction: column; }
        .page-wrap { flex: 1 0 auto; }
        .footer { flex-shrink: 0; }
        #global-alert { position: fixed; top: 16px; right: 16px; z-index: 1100; }
        .fade-out { opacity: 1; transition: opacity .4s ease; }
        .fade-out.hide { opacity: 0; }
        .input-hint { color: var(--muted); font-size: 12px; margin-top: 6px; }
        .cover-wrap { position: relative; overflow: hidden; border-radius: 12px; }
        .cover-wrap::after { content: ""; position: absolute; inset: 0; box-shadow: inset 0 0 0 1px var(--border); border-radius: 12px; pointer-events: none; }
    </style>
</head>
<body>
    <!-- 顶部导航 -->
    <nav class="navbar navbar-expand-md">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="#" style="font-weight:800;">
                <i class="bi bi-music-note-beamed me-2 text-primary"></i> 网易云音乐工具箱
            </a>
            <div class="ms-auto d-flex align-items-center gap-2"></div>
        </div>
    </nav>
    <div class="page-wrap">
        <div id="global-alert"></div>
    <div class="container mt-4">
        <div class="app-hero mb-3">
            <div class="d-flex flex-wrap align-items-center justify-content-between">
                <div class="mb-2 mb-md-0">
                    <h1 class="h3 mb-1">网易云音乐工具箱</h1>
                    <div class="subtitle small">搜索·解析·下载，一站式体验</div>
                </div>
                
            </div>
            <ul class="nav nav-pills justify-content-center gap-2 mt-3 mode-tabs" id="modeTabs">
                <li class="nav-item"><a class="nav-link active" href="#" data-mode="search"><i class="bi bi-search me-1"></i>歌曲搜索</a></li>
                <li class="nav-item"><a class="nav-link" href="#" data-mode="parse"><i class="bi bi-music-note-list me-1"></i>单曲解析</a></li>
                <li class="nav-item"><a class="nav-link" href="#" data-mode="playlist"><i class="bi bi-collection-play me-1"></i>歌单解析</a></li>
                <li class="nav-item"><a class="nav-link" href="#" data-mode="album"><i class="bi bi-vinyl me-1"></i>专辑解析</a></li>
                <li class="nav-item"><a class="nav-link" href="#" data-mode="download"><i class="bi bi-download me-1"></i>音乐下载</a></li>
            </ul>
        </div>
        <div class="card shadow-sm">
            <div class="card-body">
                <form id="main-form">
                    <div class="mb-3 d-none">
                        <label class="form-label">功能选择</label>
                        <select id="mode-select" class="form-select">
                            <option value="search" selected>歌曲搜索</option>
                            <option value="parse">单曲解析</option>
                            <option value="playlist">歌单解析</option>
                            <option value="album">专辑解析</option>
                            <option value="download">音乐下载</option>
                        </select>
                    </div>
                    <div id="search-area">
                        <div class="mb-3">
                            <label for="search_keywords" class="form-label">搜索关键词</label>
                            <input type="text" id="search_keywords" class="form-control" placeholder="输入关键词进行搜索">
                            <div class="input-hint">示例：歌名 / 歌手 / 专辑，如 “起风了” 或 “周杰伦”</div>
                        </div>
                        <div class="mb-3">
                            <label for="search_limit" class="form-label">返回数量</label>
                            <input type="number" id="search_limit" class="form-control" value="10" min="1" max="50">
                        </div>
                        <div class="text-center">
                            <button type="button" id="search-btn" class="btn btn-primary w-50"><span class="btn-text">搜索</span></button>
                        </div>
                    </div>
                    <div id="parse-area" style="display:none;">
                        <div class="mb-3">
                            <label for="song_ids" class="form-label">歌曲ID或URL</label>
                            <input type="text" id="song_ids" class="form-control" placeholder="输入歌曲ID或URL">
                            <div class="input-hint">支持链接与ID，例如：https://music.163.com/#/song?id=123456</div>
                        </div>
                        <div class="mb-3">
                            <label for="level" class="form-label">音质选择</label>
                            <select id="level" class="form-select">
                                <option value="standard">标准音质</option>
                                <option value="exhigh">极高音质</option>
                                <option value="lossless">无损音质</option>
                                <option value="hires">Hires音质</option>
                                <option value="sky">沉浸环绕声</option>
                                <option value="jyeffect">高清环绕声</option>
                                <option value="jymaster">超清母带</option>
                            </select>
                        </div>
                        <div class="text-center">
                            <button type="button" id="parse-btn" class="btn btn-primary w-50">解析</button>
                        </div>
                    </div>
                    <div id="playlist-area" style="display:none;">
                        <div class="mb-3">
                            <label for="playlist_id" class="form-label">歌单ID或链接</label>
                            <input type="text" id="playlist_id" class="form-control" placeholder="输入歌单ID或网易云歌单链接">
                            <div class="input-hint">示例：https://music.163.com/#/playlist?id=123456</div>
                        </div>
                        <div class="text-center">
                            <button type="button" id="playlist-btn" class="btn btn-warning w-50">解析歌单</button>
                        </div>
                    </div>
                    <div id="album-area" style="display:none;">
                        <div class="mb-3">
                            <label for="album_id" class="form-label">专辑ID或链接</label>
                            <input type="text" id="album_id" class="form-control" placeholder="输入专辑ID或网易云专辑链接">
                            <div class="input-hint">示例：https://music.163.com/#/album?id=123456</div>
                        </div>
                        <div class="text-center">
                            <button type="button" id="album-btn" class="btn btn-info w-50">解析专辑</button>
                        </div>
                    </div>
                    <div id="download-area" style="display:none;">
                        <div class="mb-3">
                            <label for="download_id" class="form-label">音乐ID或URL</label>
                            <input type="text" id="download_id" class="form-control" placeholder="输入音乐ID或网易云音乐链接">
                            <div class="input-hint">示例：https://music.163.com/#/song?id=123456</div>
                        </div>
                        <div class="mb-3">
                            <label for="download_quality" class="form-label">下载音质</label>
                            <select id="download_quality" class="form-select">
                                <option value="standard">标准音质</option>
                                <option value="exhigh">极高音质</option>
                                <option value="lossless" selected>无损音质</option>
                                <option value="hires">Hires音质</option>
                                <option value="sky">沉浸环绕声</option>
                                <option value="jyeffect">高清环绕声</option>
                                <option value="jymaster">超清母带</option>
                            </select>
                        </div>
                        <div class="text-center">
                            <button type="button" id="download-btn" class="btn btn-success w-50">下载音乐</button>
                        </div>
                        <div id="download-progress" class="mt-3 d-none">
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                            </div>
                            <div class="text-center mt-2">
                                <small class="text-muted">正在下载并写入元信息...</small>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <!-- 搜索结果列表 -->
        <div id="search-result" class="mt-4 d-none">
            <h5>搜索结果：</h5>
            <ul class="list-group" id="search-list"></ul>
        </div>
        <!-- 结果展示区域 -->
        <div id="song-info" class="alert alert-info d-none mt-4 p-0 border-0" style="box-shadow:0 2px 8px rgba(0,0,0,0.07);">
            <div class="row g-0 align-items-stretch">
                <div class="col-md-4 p-3">
                    <div class="cover-wrap">
                        <img id="song-cover" src="" alt="封面" style="width:100%;height:auto;display:block;object-fit:cover;">
                    </div>
                </div>
                <div class="col-md-8 p-3 d-flex flex-column justify-content-between">
                    <h4 class="mb-2" id="song_name" style="font-weight:700;"></h4>
                    <div class="mb-2"><span class="badge bg-primary me-2">歌手</span><span id="artist_names"></span></div>
                    <div class="mb-2"><span class="badge bg-secondary me-2">专辑</span><span id="song_alname"></span></div>
                    <div class="mb-2"><span class="badge bg-success me-2">音质</span><span id="song_level"></span></div>
                    <div class="mb-2"><span class="badge bg-warning text-dark me-2">大小</span><span id="song_size"></span></div>
                    <div class="mb-2">
                        <button id="show-big-pic" type="button" class="btn btn-outline-info btn-sm me-2" style="vertical-align:middle;">显示大图</button>
                    </div>
                    <div class="mb-2 d-flex align-items-center gap-2 flex-wrap">
                        <span class="badge bg-info text-dark">链接</span>
                        <a id="song_url" href="" target="_blank">点击下载</a>
                        <button id="copy-link-btn" class="btn btn-sm btn-outline-secondary" type="button"><i class="bi bi-clipboard me-1"></i>复制链接</button>
                    </div>
                    <div class="mb-2"><span class="badge bg-dark me-2">歌词</span></div>
                    <div class="lyric-box" id="lyric"></div>
                </div>
            </div>
            <div class="row g-0">
                <div class="col-12 p-3 pt-0">
                    <div id="aplayer"></div>
                </div>
            </div>
        </div>
        <!-- 歌单解析结果 -->
        <div id="playlist-result" class="mt-4 d-none">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <img id="playlist-cover" src="" alt="cover" style="width:60px;height:60px;object-fit:cover;border-radius:8px;margin-right:15px;">
                        <div class="flex-grow-1">
                            <h5 id="playlist-name" class="mb-1"></h5>
                            <div class="text-muted" id="playlist-creator"></div>
                        </div>
                        <div>
                            <button id="batch-download-btn" class="btn btn-primary">
                                <span class="batch-download-text">一键下载全部</span>
                                <span class="batch-download-spinner d-none">
                                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                    启动中...
                                </span>
                            </button>
                        </div>
                    </div>
                    <div id="playlist-desc" class="mb-2 text-secondary small"></div>
                    <div>共 <span id="playlist-count"></span> 首歌</div>
                    <!-- 批量下载进度显示区域 -->
                    <div id="batch-download-progress" class="mt-3 d-none">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">批量下载进度</h6>
                                <div class="progress mb-2" style="height: 25px;">
                                    <div id="download-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                                         role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                        <span id="download-progress-text">0%</span>
                                    </div>
                                </div>
                                <div class="row text-center">
                                    <div class="col-4">
                                        <small class="text-muted">当前歌曲</small>
                                        <div id="current-track-name" class="fw-bold">准备中...</div>
                                    </div>
                                    <div class="col-4">
                                        <small class="text-muted">进度</small>
                                        <div><span id="current-index">0</span> / <span id="total-tracks">0</span></div>
                                    </div>
                                    <div class="col-4">
                                        <small class="text-muted">状态</small>
                                        <div id="download-status" class="fw-bold text-primary">准备中</div>
                                    </div>
                                </div>
                                <div class="row mt-2 text-center">
                                    <div class="col-6">
                                        <small class="text-success">成功: <span id="success-count">0</span></small>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-danger">失败: <span id="failed-count">0</span></small>
                                    </div>
                                </div>
                                <button id="download-result-btn" class="btn btn-success btn-sm mt-2 d-none" onclick="downloadResult()">下载结果文件</button>
                            </div>
                        </div>
                    </div>
                    <div class="mt-2">
                        <label for="batch-quality" class="form-label">批量下载音质：</label>
                        <select id="batch-quality" class="form-select form-select-sm" style="width: 200px; display: inline-block;">
                            <option value="standard">标准音质</option>
                            <option value="exhigh">极高音质</option>
                            <option value="lossless" selected>无损音质</option>
                            <option value="hires">Hires音质</option>
                            <option value="sky">沉浸环绕声</option>
                            <option value="jyeffect">高清环绕声</option>
                            <option value="jymaster">超清母带</option>
                        </select>
                    </div>
                </div>
            </div>
            <ul class="list-group mt-3" id="playlist-tracks"></ul>
        </div>
        <!-- 专辑解析结果 -->
        <div id="album-result" class="mt-4 d-none">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <img id="album-cover" src="" alt="cover" style="width:60px;height:60px;object-fit:cover;border-radius:8px;margin-right:15px;">
                        <div>
                            <h5 id="album-name" class="mb-1"></h5>
                            <div class="text-muted" id="album-artist"></div>
                        </div>
                    </div>
                    <div id="album-desc" class="mb-2 text-secondary small"></div>
                    <div>共 <span id="album-count"></span> 首歌</div>
                </div>
            </div>
            <ul class="list-group mt-3" id="album-tracks"></ul>
        </div>
    </div>
    <!-- Modal for big picture -->
    <div class="modal fade" id="bigPicModal" tabindex="-1" aria-labelledby="bigPicModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bigPicModalLabel">大图预览</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="big-pic-img" src="" alt="大图" style="max-width:100%;max-height:60vh;border-radius:10px;box-shadow:0 2px 12px rgba(0,0,0,0.12);">
                </div>
            </div>
        </div>
    </div>
    </div>
    <footer class="footer mt-5 py-3 border-top" style="background: var(--card-bg);">
        <div class="container text-center text-muted small">
            <span>NetEase Cloud Music Toolbox | © <span id="year"></span> | Modified by riba2534 based on work by Suxiaoqingx | Built with Bootstrap | <a href="https://github.com/riba2534/Netease_url" target="_blank" rel="noopener noreferrer">GitHub</a></span>
        </div>
    </footer>
    <script src="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/aplayer/1.10.1/APlayer.min.js"></script>
    <script src="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/twitter-bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function() {
            // 页脚年份
            try { document.getElementById('year').textContent = new Date().getFullYear(); } catch (e) {}
            // 深色模式已移除，仅保留浅色主题

            // 顶部提示
            function showAlert(type, message) {
                const id = 'alert-' + Date.now();
                const $el = $(`<div id="${id}" class="alert alert-${type} shadow-sm fade-out">${message}</div>`);
                $('#global-alert').append($el);
                setTimeout(() => { $el.addClass('hide'); }, 2400);
                setTimeout(() => { $el.remove(); }, 2800);
            }

            // 顶部导航选中状态
            function setActiveTab(mode) {
                $('#modeTabs .nav-link').removeClass('active');
                $(`#modeTabs .nav-link[data-mode="${mode}"]`).addClass('active');
            }
            $('#modeTabs .nav-link').on('click', function(e) {
                e.preventDefault();
                const mode = $(this).data('mode');
                $('#mode-select').val(mode).trigger('change');
            });
            function lrctrim(lyrics) {
                const lines = lyrics.split('\n');
                const data = [];

                lines.forEach((line, index) => {
                    const matches = line.match(/\[(\d{2}):(\d{2}[\.:]?\d*)]/);
                    if (matches) {
                        const minutes = parseInt(matches[1], 10);
                        const seconds = parseFloat(matches[2].replace('.', ':')) || 0;
                        const timestamp = minutes * 60000 + seconds * 1000;

                        let text = line.replace(/\[\d{2}:\d{2}[\.:]?\d*\]/g, '').trim();
                        text = text.replace(/\s\s+/g, ' '); // Replace multiple spaces with a single space

                        data.push([timestamp, index, text]);
                    }
                });

                data.sort((a, b) => a[0] - b[0]);

                return data;
            }

            function lrctran(lyric, tlyric) {
                lyric = lrctrim(lyric);
                tlyric = lrctrim(tlyric);

                let len1 = lyric.length;
                let len2 = tlyric.length;
                let result = "";

                for (let i = 0, j = 0; i < len1 && j < len2; i++) {
                    while (lyric[i][0] > tlyric[j][0] && j + 1 < len2) {
                        j++;
                    }

                    if (lyric[i][0] === tlyric[j][0]) {
                        tlyric[j][2] = tlyric[j][2].replace('/', '');
                        if (tlyric[j][2]) {
                            lyric[i][2] += ` (翻译：${tlyric[j][2]})`;
                        }
                        j++;
                    }
                }

                for (let i = 0; i < len1; i++) {
                    let t = lyric[i][0];
                    result += `[${String(Math.floor(t / 60000)).padStart(2, '0')}:${String(Math.floor((t % 60000) / 1000)).padStart(2, '0')}.${String(t % 1000).padStart(3, '0')}]${lyric[i][2]}\n`;
                }

                return result;
            }

            function extractLinks(text) {
                var regex = /https?:\/\/\S+/g;
                var matches = text.match(regex);
                if (matches) {
                    return matches[0];
                } else {
                    return '';
                }
            }
    
            function checkValidLink(link) {
                if (link.indexOf("http") === -1 || 
                    (link.indexOf("music.163.com") === -1 && link.indexOf("163cn.tv") === -1)) {
                    return false;
                }
                return true;
            }
    
            function extractAndCheckId(text) {
                var link = extractLinks(text);
                if (checkValidLink(link)) {
                    return link;
                } else {
                    var idRegex = /\b\d+\b/g;
                    var ids = text.match(idRegex);
                    if (ids && ids.length > 0) {
                        return ids[0];
                    }
                    return '';
                }
            }

            // 切换功能区
            $('#mode-select').on('change', function() {
                if ($(this).val() === 'search') {
                    $('#search-area').show();
                    $('#parse-area').hide();
                    $('#playlist-area').hide();
                    $('#album-area').hide();
                    $('#download-area').hide();
                    $('#song-info').addClass('d-none');
                    $('#playlist-result').addClass('d-none');
                    $('#album-result').addClass('d-none');
                    setActiveTab('search');
                } else if ($(this).val() === 'parse') {
                    $('#search-area').hide();
                    $('#parse-area').show();
                    $('#playlist-area').hide();
                    $('#album-area').hide();
                    $('#download-area').hide();
                    $('#search-result').addClass('d-none');
                    $('#playlist-result').addClass('d-none');
                    $('#album-result').addClass('d-none');
                    setActiveTab('parse');
                } else if ($(this).val() === 'playlist') {
                    $('#search-area').hide();
                    $('#parse-area').hide();
                    $('#playlist-area').show();
                    $('#album-area').hide();
                    $('#download-area').hide();
                    $('#search-result').addClass('d-none');
                    $('#song-info').addClass('d-none');
                    $('#album-result').addClass('d-none');
                    setActiveTab('playlist');
                } else if ($(this).val() === 'album') {
                    $('#search-area').hide();
                    $('#parse-area').hide();
                    $('#playlist-area').hide();
                    $('#album-area').show();
                    $('#download-area').hide();
                    $('#search-result').addClass('d-none');
                    $('#song-info').addClass('d-none');
                    $('#playlist-result').addClass('d-none');
                    $('#album-result').addClass('d-none');
                    setActiveTab('album');
                } else if ($(this).val() === 'download') {
                    $('#search-area').hide();
                    $('#parse-area').hide();
                    $('#playlist-area').hide();
                    $('#album-area').hide();
                    $('#download-area').show();
                    $('#search-result').addClass('d-none');
                    $('#song-info').addClass('d-none');
                    $('#playlist-result').addClass('d-none');
                    $('#album-result').addClass('d-none');
                    setActiveTab('download');
                } else {
                    $('#album-area').hide();
                    $('#download-area').hide();
                    $('#album-result').addClass('d-none');
                }
            });
            // 初始化默认模式
            $('#mode-select').trigger('change');

            // 输入框回车快捷操作
            $('#search_keywords').on('keypress', function(e){ if(e.key === 'Enter'){ $('#search-btn').click(); }});
            $('#song_ids').on('keypress', function(e){ if(e.key === 'Enter'){ $('#parse-btn').click(); }});
            $('#playlist_id').on('keypress', function(e){ if(e.key === 'Enter'){ $('#playlist-btn').click(); }});
            $('#album_id').on('keypress', function(e){ if(e.key === 'Enter'){ $('#album-btn').click(); }});
            $('#download_id').on('keypress', function(e){ if(e.key === 'Enter'){ $('#download-btn').click(); }});

            // 搜索功能
            $('#search-btn').on('click', function() {
                const keywords = $('#search_keywords').val();
                const limit = $('#search_limit').val();
                if (!keywords) {
                    showAlert('warning', '请输入搜索关键词');
                    return;
                }
                const $btn = $(this);
                const originalHtml = $btn.html();
                $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-1"></span> 搜索中...');
                $.ajax({
                    url: '/Search',
                    method: 'POST',
                    data: { keyword: keywords, limit: limit },
                    dataType: 'json',
                    success: function(data) {
                        if (data.status === 200) {
                            $('#search-list').empty();
                            data.data.forEach(function(song) {
                                const item = `<li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <img src="${song.picUrl}" alt="cover" style="width:48px;height:48px;object-fit:cover;border-radius:6px;margin-right:12px;">
                                        <strong class='song-title'>${song.name}</strong> - <span>${song.artists}</span> <span class="text-muted">[${song.album}]</span>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <button class="btn btn-sm btn-outline-primary select-song me-2" data-id="${song.id}" data-name="${song.name}"><i class='bi bi-music-note-beamed me-1'></i>解析</button>
                                        <button class="btn btn-sm btn-success download-song" data-id="${song.id}" data-name="${song.name}"><i class='bi bi-download me-1'></i>下载</button>
                                    </div>
                                </li>`;
                                $('#search-list').append(item);
                            });
                            $('#search-result').removeClass('d-none');
                            showAlert('success', `搜索完成，共 ${data.data.length} 条结果`);
                        } else {
                            $('#search-list').html('<li class="list-group-item">未找到相关歌曲</li>');
                            $('#search-result').removeClass('d-none');
                            showAlert('info', '未找到相关歌曲');
                        }
                    },
                    error: function() {
                        $('#search-list').html('<li class="list-group-item">搜索失败，请重试</li>');
                        $('#search-result').removeClass('d-none');
                        showAlert('danger', '搜索失败，请重试');
                    },
                    complete: function() {
                        $btn.prop('disabled', false).html(originalHtml);
                    }
                });
            });

            // 搜索结果点击解析
            $(document).on('click', '.select-song', function() {
                const songId = $(this).data('id');
                $('#song_ids').val(songId);
                $('#mode-select').val('parse').trigger('change');
                $('html,body').animate({scrollTop: $('#main-form').offset().top}, 300);
            });

            // 单曲解析
            $('#parse-btn').on('click', function() {
                const songIds = $('#song_ids').val();
                const level = $('#level').val();
                if (!songIds) {
                    showAlert('warning', '请输入歌曲ID或URL');
                    return;
                }
                $.post('/Song_V1', { url: songIds, level: level, type:'json' }, function(data) {
                    if (data.status === 200) {
                        $('#song_name').text(data.data.name);
                        $('#artist_names').text(data.data.ar_name);
                        $('#song_alname').text(data.data.al_name);
                        $('#song_level').text(data.data.level);
                        $('#song_size').text(data.data.size);
                        let processedLyrics = data.data.lyric;
                        if (data.data.tlyric) {
                            processedLyrics = lrctran(data.data.lyric, data.data.tlyric);
                        }
                        $('#lyric').html(processedLyrics.replace(/\n/g, '<br>'));
                        $('#song_url').attr('href', data.data.url).text('点击下载');
                        $('#song-cover').attr('src', data.data.pic || '');
                        $('#copy-link-btn').data('url', data.data.url || '');
                        $('#song-info').removeClass('d-none');
                        $('#show-big-pic').data('pic', data.data.pic);
                        // 释放之前的播放器实例
                        try { if (window._aplayer && window._aplayer.destroy) { window._aplayer.destroy(); } } catch(e){}
                        document.getElementById('aplayer').innerHTML = '';
                        window._aplayer = new APlayer({
                            container: document.getElementById('aplayer'),
                            lrcType: 1,
                            audio: [{
                                name: data.data.name,
                                artist: data.data.ar_name,
                                url: data.data.url,
                                cover: data.data.pic,
                                lrc: processedLyrics
                            }]
                        });
                    } else {
                        showAlert('danger', (data && data.message) || (data && data.data && data.data.msg) || '解析失败');
                    }
                }, 'json');
            });

            // 复制下载链接
            $(document).on('click', '#copy-link-btn', async function(){
                const url = $(this).data('url') || $('#song_url').attr('href');
                if(!url){ showAlert('warning', '没有可复制的链接'); return; }
                try{
                    await navigator.clipboard.writeText(url);
                    showAlert('success', '下载链接已复制');
                }catch(err){
                    // 兼容不支持 clipboard 的环境
                    const $tmp = $('<input>');
                    $('body').append($tmp);
                    $tmp.val(url).select();
                    document.execCommand('copy');
                    $tmp.remove();
                    showAlert('success', '下载链接已复制');
                }
            });

            // 显示大图按钮事件
            $(document).on('click', '#show-big-pic', function() {
                var picUrl = $(this).data('pic');
                $('#big-pic-img').attr('src', picUrl);
                var modal = new bootstrap.Modal(document.getElementById('bigPicModal'));
                modal.show();
            });

            // 歌单解析
            $('#playlist-btn').on('click', function() {
                let pid = $('#playlist_id').val().trim();
                if (!pid) {
                    showAlert('warning', '请输入歌单ID或链接');
                    return;
                }
                // 支持直接粘贴歌单链接
                const idMatch = pid.match(/playlist\?id=(\d+)/);
                if (idMatch) pid = idMatch[1];
                
                // 保存歌单ID用于批量下载
                window.currentPlaylistId = pid;
                
                $.get('/Playlist', { id: pid }, function(data) {
                    if (data.status === 200) {
                        const pl = data.data.playlist;
                        $('#playlist-cover').attr('src', pl.coverImgUrl);
                        $('#playlist-name').text(pl.name);
                        $('#playlist-creator').text('by ' + pl.creator);
                        $('#playlist-desc').text(pl.description || '');
                        $('#playlist-count').text(pl.trackCount);
                        $('#playlist-tracks').empty();
                        pl.tracks.forEach(function(song, idx) {
                            const item = `<li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <img src="${song.picUrl}" alt="cover" style="width:40px;height:40px;object-fit:cover;border-radius:6px;margin-right:10px;">
                                    <strong class="playlist-title">${idx+1}. ${song.name}</strong> - <span>${song.artists}</span> <span class="text-muted">[${song.album}]</span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <button class="btn btn-sm btn-outline-primary select-song me-2" data-id="${song.id}" data-name="${song.name}"><i class='bi bi-music-note-beamed me-1'></i>解析</button>
                                    <button class="btn btn-sm btn-success download-song" data-id="${song.id}" data-name="${song.name}"><i class='bi bi-download me-1'></i>下载</button>
                                </div>
                            </li>`;
                            $('#playlist-tracks').append(item);
                        });
                        $('#playlist-result').removeClass('d-none');
                    } else {
                        $('#playlist-result').removeClass('d-none');
                        $('#playlist-tracks').html('<li class="list-group-item">歌单解析失败：'+((data && data.message) || '未知错误')+'</li>');
                        showAlert('danger', '歌单解析失败');
                    }
                }, 'json');
            });
            
            // 全局变量存储当前下载任务
            window.currentDownloadTask = null;

            // 批量下载歌单 - 新的非阻塞版本
            $('#batch-download-btn').on('click', function() {
                if (!window.currentPlaylistId) {
                    showAlert('info', '请先解析歌单');
                    return;
                }

                const $btn = $(this);
                const quality = $('#batch-quality').val();

                // 显示加载状态
                $btn.prop('disabled', true);
                $btn.find('.batch-download-text').addClass('d-none');
                $btn.find('.batch-download-spinner').removeClass('d-none');

                // 启动批量下载任务
                $.ajax({
                    url: '/batch_download_v2',
                    method: 'POST',
                    data: {
                        playlist_id: window.currentPlaylistId,
                        quality: quality
                    },
                    dataType: 'json',
                    success: function(response) {
                        if (response.status === 200) {
                            // 任务启动成功，开始监听进度
                            window.currentDownloadTask = response.data.task_id;
                            startProgressMonitoring(response.data.task_id, response.data.playlist_name, response.data.total_tracks);
                        } else {
                            showAlert('danger', '启动下载任务失败: ' + (response.data.msg||''));
                            resetBatchDownloadButton();
                        }
                    },
                    error: function(xhr, status, error) {
                        showAlert('danger', '启动下载任务失败，请重试');
                        resetBatchDownloadButton();
                    }
                });
            });

            // 重置批量下载按钮状态
            function resetBatchDownloadButton() {
                const $btn = $('#batch-download-btn');
                $btn.prop('disabled', false);
                $btn.find('.batch-download-text').removeClass('d-none');
                $btn.find('.batch-download-spinner').addClass('d-none');
            }

            // 开始进度监听
            function startProgressMonitoring(taskId, playlistName, totalTracks) {
                // 显示进度区域
                $('#batch-download-progress').removeClass('d-none');
                $('#total-tracks').text(totalTracks);

                // 创建 EventSource 连接
                const eventSource = new EventSource(`/download_progress/${taskId}`);

                eventSource.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        updateProgressDisplay(data);

                        // 如果任务完成或失败，关闭连接
                        if (data.status === 'completed' || data.status === 'failed') {
                            eventSource.close();
                            handleDownloadComplete(data);
                        }
                    } catch (e) {
                        console.error('解析进度数据失败:', e);
                    }
                };

                eventSource.onerror = function(event) {
                    console.error('SSE连接错误:', event);
                    eventSource.close();
                    showAlert('warning', '进度监听连接断开，请刷新页面重试');
                    resetBatchDownloadButton();
                };
            }

            // 更新进度显示
            function updateProgressDisplay(data) {
                const totalTracks = data.total_count || 0;
                const currentIndex = data.current_index || 0;
                const successCount = data.success_count || 0;
                const failedCount = data.failed_count || 0;

                // 计算进度百分比
                let progressPercent = 0;
                if (totalTracks > 0) {
                    progressPercent = Math.round((currentIndex / totalTracks) * 100);
                }

                // 更新进度条
                $('#download-progress-bar').css('width', progressPercent + '%');
                $('#download-progress-text').text(progressPercent + '%');

                // 更新当前歌曲信息
                $('#current-track-name').text(data.current_track || '准备中...');
                $('#current-index').text(currentIndex);
                $('#success-count').text(successCount);
                $('#failed-count').text(failedCount);

                // 更新状态显示
                let statusText = '准备中';
                let statusClass = 'text-primary';
                switch (data.status) {
                    case 'starting':
                        statusText = '启动中';
                        statusClass = 'text-info';
                        break;
                    case 'downloading':
                        statusText = '下载中';
                        statusClass = 'text-warning';
                        break;
                    case 'packing':
                        statusText = '打包中';
                        statusClass = 'text-info';
                        break;
                    case 'completed':
                        statusText = '完成';
                        statusClass = 'text-success';
                        break;
                    case 'failed':
                        statusText = '失败';
                        statusClass = 'text-danger';
                        break;
                }
                $('#download-status').removeClass('text-primary text-info text-warning text-success text-danger').addClass(statusClass).text(statusText);
            }

            // 处理下载完成
            function handleDownloadComplete(data) {
                resetBatchDownloadButton();

                if (data.status === 'completed') {
                    // 显示下载完成消息
                    showAlert('success', `批量下载完成！成功 ${data.success_count} · 失败 ${data.failed_count}`);

                    // 显示下载结果按钮
                    $('#download-result-btn').removeClass('d-none');

                    // 自动触发下载
                    downloadResult();
                } else if (data.status === 'failed') {
                    showAlert('danger', '批量下载失败: ' + (data.error_message || '未知错误'));
                    // 隐藏进度区域
                    $('#batch-download-progress').addClass('d-none');
                }
            }

            // 下载结果文件
            function downloadResult() {
                if (window.currentDownloadTask) {
                    window.location.href = `/download_result/${window.currentDownloadTask}`;
                    // 延迟隐藏进度区域和按钮
                    setTimeout(function() {
                        $('#batch-download-progress').addClass('d-none');
                        $('#download-result-btn').addClass('d-none');
                        window.currentDownloadTask = null;
                    }, 2000);
                }
            }

            // 专辑解析
            $(document).on('click', '#album-btn', function() {
                let aid = $('#album_id').val().trim();
                if (!aid) {
                    alert('请输入专辑ID或链接');
                    return;
                }
                // 支持直接粘贴专辑链接
                const idMatch = aid.match(/album\?id=(\d+)/);
                if (idMatch) aid = idMatch[1];
                $.get('/Album', { id: aid }, function(data) {
                    if (data.status === 200) {
                        const al = data.data.album;
                        $('#album-cover').attr('src', al.coverImgUrl);
                        $('#album-name').text(al.name);
                        $('#album-artist').text(al.artist);
                        $('#album-desc').text(al.description || '');
                        $('#album-count').text(al.songs.length);
                        $('#album-tracks').empty();
                        al.songs.forEach(function(song, idx) {
                            const item = `<li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <img src="${song.picUrl}" alt="cover" style="width:40px;height:40px;object-fit:cover;border-radius:6px;margin-right:10px;">
                                    <strong class="playlist-title">${idx+1}. ${song.name}</strong> - <span>${song.artists}</span> <span class="text-muted">[${song.album}]</span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <button class="btn btn-sm btn-outline-primary select-song me-2" data-id="${song.id}" data-name="${song.name}"><i class='bi bi-music-note-beamed me-1'></i>解析</button>
                                    <button class="btn btn-sm btn-success download-song" data-id="${song.id}" data-name="${song.name}"><i class='bi bi-download me-1'></i>下载</button>
                                </div>
                            </li>`;
                            $('#album-tracks').append(item);
                        });
                        $('#album-result').removeClass('d-none');
                    } else {
                        $('#album-result').removeClass('d-none');
                        $('#album-tracks').html('<li class="list-group-item">专辑解析失败：'+((data && data.message) || '未知错误')+'</li>');
                        showAlert('danger', '专辑解析失败');
                    }
                }, 'json');
            });

            // 音乐下载功能
            $('#download-btn').on('click', function() {
                const musicId = $('#download_id').val().trim();
                const quality = $('#download_quality').val();
                
                if (!musicId) {
                    showAlert('warning', '请输入音乐ID或URL');
                    return;
                }
                
                // 提取ID（支持URL格式）
                let processedId = musicId;
                const idMatch = musicId.match(/song\?id=(\d+)/);
                if (idMatch) {
                    processedId = idMatch[1];
                }
                
                // 显示进度条
                $('#download-progress').removeClass('d-none');
                $('#download-btn').prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-1"></span> 下载中...');
                
                // 使用XMLHttpRequest来处理下载并获取响应头
                const xhr = new XMLHttpRequest();
                xhr.open('POST', '/Download', true);
                xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                xhr.responseType = 'blob';
                
                xhr.onload = function() {
                    if (xhr.status === 200) {
                        // 获取自定义响应头
                        const downloadMessage = xhr.getResponseHeader('X-Download-Message');
                        const encodedFilename = xhr.getResponseHeader('X-Download-Filename');
                        const filename = encodedFilename ? decodeURIComponent(encodedFilename) : 'music.flac';
                        
                        // 创建下载链接
                        const blob = xhr.response;
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename || 'music.flac';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                        
                        // 显示完成提示
                        showAlert('success', '音乐文件下载完成！');
                        console.log(`下载完成: ${filename}`);
                        if (downloadMessage) {
                            console.log(`服务器消息: ${downloadMessage}`);
                        }
                    } else {
                        showAlert('danger', '下载失败，请重试');
                    }
                    
                    // 重置按钮状态
                    $('#download-progress').addClass('d-none');
                    $('#download-btn').prop('disabled', false).text('下载音乐');
                };
                
                xhr.onerror = function() {
                    showAlert('danger', '下载出错，请重试');
                    $('#download-progress').addClass('d-none');
                    $('#download-btn').prop('disabled', false).text('下载音乐');
                };
                
                // 发送请求
                const formData = `id=${encodeURIComponent(processedId)}&quality=${encodeURIComponent(quality)}`;
                xhr.send(formData);
            });

            // 列表中的下载按钮点击事件
            // 下载按钮点击跳转到下载功能
            $(document).on('click', '.download-song', function() {
                const musicId = $(this).data('id');
                const songName = $(this).data('name');
                
                if (!musicId) {
                    showAlert('warning', '无法获取音乐ID');
                    return;
                }
                
                // 填充下载ID并跳转到下载功能区域
                $('#download_id').val(musicId);
                $('#mode-select').val('download').trigger('change');
                $('html,body').animate({scrollTop: $('#main-form').offset().top}, 300);
            });
        });
    </script>
</body>
</html>
